name: K6 Performance Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  k6_performance_tests:
    name: Run K6 Performance Tests
    runs-on: ubuntu-latest
    env:
      EMAIL_USER: sdetyogesh@proton.me
      EMAIL_RECIPIENT: yogi.wankhede007@gmail.com
      ENVIRONMENT: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install

      - name: Install k6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Create reports directory
        run: mkdir -p reports

      - name: Run Smoke Test
        run: k6 run src/tests/smoke-test.js
        env:
          K6_OUT: json=reports/smoke-test-results.json
          EMAIL_APP_PASSWORD: ${{ secrets.EMAIL_APP_PASSWORD }}

      - name: Run Load Test
        run: k6 run src/tests/load-test.js
        env:
          K6_OUT: json=reports/load-test-results.json
          EMAIL_APP_PASSWORD: ${{ secrets.EMAIL_APP_PASSWORD }}

      - name: Send Email Reports
        run: |
          node scripts/send-report.js "Smoke"
          node scripts/send-report.js "Load"
        env:
          EMAIL_APP_PASSWORD: ${{ secrets.EMAIL_APP_PASSWORD }}

      - name: Upload Test Reports
        uses: actions/upload-artifact@v2
        with:
          name: k6-test-reports
          path: reports/
          retention-days: 30

      - name: Notify on Failure
        if: failure()
        run: |
          node scripts/send-report.js "Failed"
        env:
          EMAIL_APP_PASSWORD: ${{ secrets.EMAIL_APP_PASSWORD }} 